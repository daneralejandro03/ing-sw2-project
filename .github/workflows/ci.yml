name: CI Backend

on:
  push: 
    branches: [ salazardevelopment ]
  pull_request:
    branches: [ salazardevelopment ]  
  workflow_dispatch:

jobs:
  backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      # Set environment variables for ms-notifications
      - name: Set environment variables for ms-notifications
        run: |
          echo "EMAIL_CONNECTION_STRING=${{ secrets.EMAIL_CONNECTION_STRING }}" >> $GITHUB_ENV
          echo "EMAIL_SENDER_ADDRESS=${{ secrets.EMAIL_SENDER_ADDRESS }}" >> $GITHUB_ENV
          echo "TWILIO_SID=${{ secrets.TWILIO_SID }}" >> $GITHUB_ENV
          echo "TWILIO_AUTH_TOKEN=${{ secrets.TWILIO_AUTH_TOKEN }}" >> $GITHUB_ENV
          echo "TWILIO_FROM=${{ secrets.TWILIO_FROM }}" >> $GITHUB_ENV

      # Set environment variables for ms-security
      - name: Set environment variables for ms-security
        run: |
          echo "MONGODB_URI=${{ secrets.MONGODB_URI }}" >> $GITHUB_ENV
          echo "NOTIFICATION_API_URL=${{ secrets.NOTIFICATION_API_URL }}" >> $GITHUB_ENV
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> $GITHUB_ENV

      # Install dependencies for ms-notifications
      - name: Install dependencies for ms-notifications
        run: |
          cd BACKEND/ms-notifications
          npm install

      # Install dependencies for ms-security
      - name: Install dependencies for ms-security
        run: |
          cd BACKEND/ms-security
          npm install

      # Start ms-notifications
      - name: Start ms-notifications
        run: |
          cd BACKEND/ms-notifications
          PORT=3001 npm run start &

      # Start ms-security
      - name: Start ms-security
        run: |
          cd BACKEND/ms-security
          PORT=3002 npm run start
